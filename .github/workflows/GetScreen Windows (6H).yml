name: GetScreen Windows (Enhanced)

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Load Environment Variables
        run: |
          if (Test-Path ".env") {
            Write-Host "Loading .env file..." -ForegroundColor Cyan
            Get-Content .env | ForEach-Object {
              if ($_ -match '^([^#][^=]+)=(.*)$') {
                $name = $matches[1].Trim()
                $value = $matches[2].Trim()
                echo "$name=$value" >> $env:GITHUB_ENV
                Write-Host "✓ Loaded: $name" -ForegroundColor Green
              }
            }
          } else {
            Write-Host "ERROR: .env file not found!" -ForegroundColor Red
            exit 1
          }
        shell: pwsh
        
      - name: Validate Configuration
        run: |
          Write-Host "`n=== Validating Configuration ===" -ForegroundColor Cyan
          
          $errors = @()
          
          if (-not $env:RUNTIME_HOURS) {
            $errors += "RUNTIME_HOURS is missing"
          } else {
            Write-Host "✓ Runtime Hours: $env:RUNTIME_HOURS" -ForegroundColor Green
          }
          
          if (-not $env:EMAIL_SECRET) {
            $errors += "EMAIL_SECRET is missing"
          } else {
            Write-Host "✓ Email: $env:EMAIL_SECRET" -ForegroundColor Green
          }
          
          if (-not $env:DOWNLOAD_URL) {
            $errors += "DOWNLOAD_URL is missing"
          } else {
            $urlPreview = if ($env:DOWNLOAD_URL.Length -gt 60) { 
              $env:DOWNLOAD_URL.Substring(0, 57) + "..." 
            } else { 
              $env:DOWNLOAD_URL 
            }
            Write-Host "✓ Download URL: $urlPreview" -ForegroundColor Green
          }
          
          if ($errors.Count -gt 0) {
            Write-Host "`nERROR: Missing required variables in .env:" -ForegroundColor Red
            $errors | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
            exit 1
          }
          
          Write-Host "`n✓ All configurations validated successfully!" -ForegroundColor Green
        shell: pwsh
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests psutil
        shell: pwsh
        
      - name: System Information
        run: |
          Write-Host "`n=== System Information ===" -ForegroundColor Cyan
          Write-Host "OS: $(Get-WmiObject Win32_OperatingSystem | Select -ExpandProperty Caption)"
          Write-Host "CPU: $(Get-WmiObject Win32_Processor | Select -ExpandProperty Name)"
          Write-Host "RAM: $([math]::Round((Get-WmiObject Win32_ComputerSystem).TotalPhysicalMemory/1GB, 2)) GB"
          Write-Host "Disk Free: $([math]::Round((Get-PSDrive C).Free/1GB, 2)) GB"
          Write-Host "PowerShell: $($PSVersionTable.PSVersion)"
          Write-Host "Python: $(python --version)"
        shell: pwsh
        
      - name: Setup Workspace
        run: |
          echo "START_TIME=$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $env:GITHUB_ENV
          Write-Host "`n✓ Workspace ready" -ForegroundColor Green
        shell: pwsh
        
      - name: Download Script
        run: |
          try {
            Write-Host "`n=== Downloading Script ===" -ForegroundColor Cyan
            
            $url = $env:DOWNLOAD_URL
            $output = "$env:WORKSPACE\down.bat"
            $maxRetries = 3
            
            for ($i = 1; $i -le $maxRetries; $i++) {
              try {
                Write-Host "Attempt $i of ${maxRetries}..." -ForegroundColor Yellow
                
                Invoke-WebRequest -Uri $url -OutFile $output -TimeoutSec 30
                
                if (Test-Path $output) {
                  $size = (Get-Item $output).Length
                  Write-Host "✓ Download successful! Size: $size bytes" -ForegroundColor Green
                  break
                }
              } catch {
                if ($i -eq $maxRetries) {
                  throw "Failed after $maxRetries attempts: $_"
                }
                Write-Host "Failed. Retrying in 5 seconds..." -ForegroundColor Red
                Start-Sleep -Seconds 5
              }
            }
            
          } catch {
            Write-Host "`nERROR: $_" -ForegroundColor Red
            exit 1
          }
        shell: pwsh
        
      - name: Execute Script
        run: |
          try {
            Write-Host "`n=== Executing Script ===" -ForegroundColor Cyan
            
            $scriptPath = "$env:WORKSPACE\down.bat"
            
            if (-not (Test-Path $scriptPath)) {
              throw "Script file not found: $scriptPath"
            }
            
            Write-Host "Running: $scriptPath" -ForegroundColor Yellow
            cmd /c $scriptPath
            
            Write-Host "✓ Script execution completed" -ForegroundColor Green
            
          } catch {
            Write-Host "`nERROR: $_" -ForegroundColor Red
            exit 1
          }
        shell: pwsh
        
      - name: Time Counter
        run: |
          # Create Python time counter script
          @"
          import time
          import sys
          import os
          from datetime import datetime, timedelta
          
          def format_time(seconds):
              h = int(seconds // 3600)
              m = int((seconds % 3600) // 60)
              s = int(seconds % 60)
              return f"{h:02d}:{m:02d}:{s:02d}"
          
          def main():
              hours = float(os.environ.get('RUNTIME_HOURS', '6'))
              total_sec = int(hours * 3600)
              
              start = datetime.now()
              end = start + timedelta(seconds=total_sec)
              
              print("\n" + "="*60)
              print(f"⏰ Start: {start.strftime('%Y-%m-%d %H:%M:%S')}")
              print(f"⏰ End:   {end.strftime('%Y-%m-%d %H:%M:%S')}")
              print(f"⏱️  Duration: {hours} hours ({total_sec} seconds)")
              print("="*60 + "\n")
              
              elapsed = 0
              checkpoint = 300  # 5 minutes
              last_check = 0
              
              try:
                  while elapsed < total_sec:
                      remain = total_sec - elapsed
                      progress = (elapsed / total_sec) * 100
                      
                      bar_len = 40
                      filled = int(bar_len * elapsed / total_sec)
                      bar = "█" * filled + "░" * (bar_len - filled)
                      
                      sys.stdout.write(
                          f"\r[{bar}] {progress:5.1f}% | "
                          f"⏳ {format_time(elapsed)} | "
                          f"⏱️  {format_time(remain)} "
                      )
                      sys.stdout.flush()
                      
                      if elapsed - last_check >= checkpoint:
                          now = datetime.now().strftime('%H:%M:%S')
                          print(f"\n[{now}] ✓ Checkpoint: {format_time(elapsed)} elapsed")
                          last_check = elapsed
                      
                      time.sleep(60)
                      elapsed += 60
                      
              except KeyboardInterrupt:
                  print("\n\n⚠️  Interrupted by user")
                  sys.exit(0)
              
              print(f"\n\n{'='*60}")
              print(f"✅ Completed! Total: {format_time(elapsed)}")
              print("="*60)
          
          if __name__ == "__main__":
              main()
          "@ | Out-File -FilePath "time.py" -Encoding UTF8
          
          Write-Host "`n=== Starting Time Counter ===" -ForegroundColor Cyan
          python time.py
        shell: pwsh
        
      - name: Cleanup
        if: always()
        run: |
          Write-Host "`n=== Cleanup ===" -ForegroundColor Cyan
          
          if (Test-Path $env:WORKSPACE) {
            Remove-Item -Path $env:WORKSPACE -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "✓ Workspace cleaned" -ForegroundColor Green
          }
        shell: pwsh
        
      - name: Summary
        if: always()
        run: |
          Write-Host "`n=== Workflow Summary ===" -ForegroundColor Cyan
          Write-Host "Start:  $env:START_TIME"
          Write-Host "End:    $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Host "Status: ${{ job.status }}"
          Write-Host "="*50
        shell: pwsh
